name: Build and Publish Beta Packages

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    tags: ["v*"]

permissions:
  contents: read
  packages: write

jobs:
  build_and_publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set commit metadata for non-tag builds
        if: ${{ !startsWith(github.ref, 'refs/tags/v') }}
        run: echo "MINVERBUILDMETADATA=${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Install MinVer CLI
        run: dotnet tool install --global minver-cli --version 5.*

      - name: Determine version with MinVer
        # Explicit working directory avoids MinVer resolving an empty path on tagged builds
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          echo "MinVer working dir: $PWD"
          buildMetadataArgs=()
          if [ -n "${MINVERBUILDMETADATA:-}" ]; then
            buildMetadataArgs+=(--build-metadata "$MINVERBUILDMETADATA")
          fi
          # MinVer expects the path as the first positional argument
          VERSION=$(minver "$PWD" -t v --default-pre-release-phase beta --verbosity info "${buildMetadataArgs[@]:-}")
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "Using version: $VERSION"

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Pack
        run: dotnet pack -c Release --no-build --output ./nupkgs

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Generate VS Code extension files
        run: |
          set -euo pipefail
          CLI_DLL=$(find ./Output/bin/Parseidon.Cli/Release -name 'dotnet-parseidon.dll' -print -quit)
          if [ -z "$CLI_DLL" ]; then
            echo "CLI binary not found" >&2
            exit 1
          fi
          dotnet "$CLI_DLL" vscode ./common/parseidon.pgram ./Output/VSCodePackage -o override -v "${VERSION}"

      - name: Prepare VS Code package assets
        run: |
          set -euo pipefail
          mkdir -p ./Output/VSCodePackage
          cp LICENSE ./Output/VSCodePackage/
          if [ -d ./assets/vsce ]; then
            cp -a ./assets/vsce/. ./Output/VSCodePackage/
          fi

      - name: Package VS Code extension (.vsix)
        env:
          VERSION: ${{ env.VERSION }}
        run: |
          set -euo pipefail
          mkdir -p ./Output/artifacts
          pushd ./Output/VSCodePackage
          npx --yes @vscode/vsce package --no-dependencies --out ../artifacts/parseidon-vscode-${VERSION}.vsix
          popd

      - name: Upload VS Code extension artifact
        uses: actions/upload-artifact@v4
        env:
          VERSION: ${{ env.VERSION }}
        with:
          name: parseidon-vscode-${{ env.VERSION }}
          path: Output/artifacts/parseidon-vscode-${{ env.VERSION }}.vsix
          if-no-files-found: error

      - name: Publish VS Code extension to Marketplace
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          VERSION: ${{ env.VERSION }}
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${VSCE_PAT:-}" ]; then
            echo "VSCE_PAT secret is required to publish the VS Code extension" >&2
            exit 1
          fi
          npx --yes @vscode/vsce publish --no-dependencies --packagePath "Output/artifacts/parseidon-vscode-${VERSION}.vsix" --pat "$VSCE_PAT"

      - name: Publish packages to GitHub Packages
        run: |
          dotnet nuget push ./nupkgs/*.nupkg --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --api-key "${{ secrets.GITHUB_TOKEN }}" --skip-duplicate
          dotnet nuget push ./nupkgs/*.snupkg --source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" --api-key "${{ secrets.GITHUB_TOKEN }}" --skip-duplicate

      - name: Publish packages to NuGet.org
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          dotnet nuget push ./nupkgs/*.nupkg --source "https://api.nuget.org/v3/index.json" --api-key "${{ secrets.NUGET_API_KEY }}" --skip-duplicate
          dotnet nuget push ./nupkgs/*.snupkg --source "https://api.nuget.org/v3/index.json" --api-key "${{ secrets.NUGET_API_KEY }}" --skip-duplicate
